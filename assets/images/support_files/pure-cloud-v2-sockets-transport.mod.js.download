/*!
 * widgets
 * @version: 9.0.017.26
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([22],{"./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js":function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){var n={};for(var o in e)t.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=e[o]);return n}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},d=n("./node_modules/jquery/dist/jquery.js"),m=o(d),g=n("./webapp/plugins/cx-common/cx-common.js"),u=o(g),l={init:function(e){l.transport=e},updateSessionCookies:function(){var e=l.transport,t=e.oSessionData;u.default.setCookie(e.sCookie_Keys,t.jwt),u.default.setCookie(e.sCookie_ConversationID,t.conversationId),u.default.setCookie(e.sCookie_MemberID,t.memberId),u.default.setCookie(e.sCookie_WS_URL,t.WebSocketUrl),u.default.setCookie(e.sLastMessageId,t.lastMessageId)},removeCookies:function(){var e=l.transport;u.default.deleteCookie(e.sCookie_Keys),u.default.deleteCookie(e.sCookie_ConversationID),u.default.deleteCookie(e.sCookie_MemberID),u.default.deleteCookie(e.sCookie_WS_URL),u.default.deleteCookie(e.sLastMessageId)},getSessionFromCookie:function(){var e=l.transport,t=l.transport.oSessionData;t.jwt=u.default.getCookie(e.sCookie_Keys),t.conversationId=u.default.getCookie(e.sCookie_ConversationID),t.memberId=u.default.getCookie(e.sCookie_MemberID),t.WebSocketUrl=u.default.getCookie(e.sCookie_WS_URL),t.lastMessageId=u.default.getCookie(e.sLastMessageId),e.customerId=t.memberId},terminateChatSession:function(){var e=l.transport;l.removeCookies(),e.bSessionActive=!1,e.mySocket&&(clearTimeout(e.WebSocketTimeout),e.mySocket.readyState===WebSocket.OPEN&&setTimeout(function(){e.mySocket&&e.mySocket.close()},e.socketConnectionCloseTime),e.mySocket=null),e.oAgents={},e.oClients={},e.oWorkFlows={},e.oSessionData={},e.bAllMessagesReceived=!1,e.bOpeningSocket=!1,e.bFetchingMembers=!1},getFormData:function(e){if(e){var t=u.default.getBrowserandOS(),n=e.firstname,o=e.lastname,s=e.nickname,a=r(e,["firstname","lastname","nickname"]),d={_genesys_source:u.default.isMobileDevice()?"mobile":"web",_genesys_referrer:document.referrer,_genesys_url:document.location.href,_genesys_pageTitle:document.title,_genesys_browser:t.browser,_genesys_OS:t.os},m=c({},l.transport.oUserData,d);return"object"==i(e.userData)&&(m=c({},m,e.userData)),c({firstName:n,lastName:o,nickname:s},m,a)}return{}},messagesInSync:function(e,t){var n=!0;return e.length!=t.length?n=!1:e.forEach(function(e,o){e.id&&t[o]&&t[o].id?e.id!=t[o].id&&(n=!1):n=!1}),n},parseTranscript:function(e,t){var n=l.transport,o=[];clearInterval(n.fWatchMembers),n.fWatchMembers=!1,m.default.each(e||[],function(){var e=this;l.checkChatIndexHash(e.id)&&o.push(l.parseFormatmessage(e,t))}),o.sort(function(e,t){return e.timestamp-t.timestamp}),e&&e.sort(function(e,t){return e.iTempIndex-t.iTempIndex}),t&&"fetchHistory"==t.type&&(o.sort(function(e,t){return t.index-e.index}),e&&e.sort(function(e,t){return t.iTempIndex-e.iTempIndex})),e&&e.length>0&&(e=e.map(function(e){return delete e.iTempIndex,e})),o.length>0&&l.messagesInSync(o,e)&&n.onMessageReceived({data:{originalMessages:e,messages:o,restoring:n.bRestoring,oldMessages:t&&"fetchHistory"==t.type}})},checkChatIndexHash:function(e){var t=l.transport;return!t.oChatIndexHash[e]&&(t.oChatIndexHash[e]=!0,!0)},sendBotConnected:function(e,t){var n=l.transport;l.postMessageWithTimestamp({type:"ParticipantJoined",index:t?t.index:0,timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotConnected({message:e,agents:n.oAgents})},sendBotDisconnected:function(e,t){var n=l.transport;l.postMessageWithTimestamp({type:"ParticipantLeft",index:t?t.index:"",timestamp:t?t.timestamp:Date.now(),from:{type:"Bot"}}),n.onBotDisconnected({message:e,agents:n.oAgents})},parseMessageForEvents:function(e,t){var n=l.transport,o=t||{},s=o.type,r=!(!s||"restore"!==s&&"fetchHistory"!==s),a=!(!s||"offlineMessages"!==s),i={};if(e&&e.state){var c=e.state,d=e.role,g=e.sender.id,u={};if(n.oPresences&&Object.keys(n.oPresences).length&&(u=n.oPresences.filter(function(e){return e.id==g}),u=u[0]),"CONNECTED"==c){var p={};switch("AGENT"==d&&n.oAgents[g]&&(p=m.default.extend(!0,{},n.oAgents),n.oAgents[g].connected=!0,n.oAgents[g].supervisor=!1,n.oAgents[g].connectedTime=e.joinDate||u&&Object.keys(u).length?new Date(u.joinDate).getTime():"",p[g].connected=!0,p[g].supervisor=!1,p[g].connectedTime=e.joinDate||u&&Object.keys(u).length?new Date(u.joinDate).getTime():"",n.oCacheAgents[g]=JSON.parse(JSON.stringify(n.oAgents[g]))),i={message:e,agents:p},d){case"AGENT":l.checkEventChanged(g,c)&&n.onAgentConnected(i);break;case"CUSTOMER":l.checkEventChanged(g,c)&&n.onClientConnected(i);break;case"WORKFLOW":n.botEventsEnabled&&l.checkEventChanged(g,c)&&n.onBotConnected(i)}}else if("DISCONNECTED"==c){var f={};switch("AGENT"==d&&n.oAgents[g]&&(f=m.default.extend(!0,{},n.oAgents),n.oAgents[g].connected=!1,n.oAgents[g].disconnectedTime=e.leaveDate||u&&Object.keys(u).length&&u.leaveDate?new Date(u.leaveDate).getTime():new Date(e.timestamp).getTime(),f[g].connected=!1,f[g].disconnectedTime=e.leaveDate||u&&Object.keys(u).length&&u.leaveDate?new Date(u.leaveDate).getTime():new Date(e.timestamp).getTime()),i={message:e,agents:f},d){case"AGENT":n.onAgentDisconnected(i),n.onAgentTypingStopped(i);break;case"CUSTOMER":n.onClientDisconnected(i);break;case"WORKFLOW":n.botEventsEnabled&&n.onBotDisconnected(i)}}(r||a)&&(n.oMembers[g]=e,n.oMembers[g].lastEvent=c)}},parseFormatmessage:function(e,t){var n=l.transport,o=new Date(e.timestamp||e.joinDate||e.leaveDate).getTime(),s=t||{},r=s.type,a=!(!r||"restore"!==r&&"fetchHistory"!==r),i=!(!r||"offlineMessages"!==r),c={},d={};if(c.type=n.webSocketStateMapping[e.bodyType]||"Message","Message"===c.type&&(c.text=e.body),c.restoring=n.bRestoring,c.index=o,e.iTempIndex=o,c.timestamp=o,c.id=e.id,n.oPresences&&Object.keys(n.oPresences).length){d=n.oPresences.filter(function(t){return t.id==e.sender.id});for(var m=0;m<d.length;m++)d=d[m],e.role=d&&d.role?d.role:n.oMembers[e.sender.id].role,e.state=n.stateMapping[c.type],"AGENT"==e.role&&(n.agentMsgFormat.avatar=d&&d.avatarImageUrl?d.avatarImageUrl:"",d&&"CONNECTED"==d.state&&(n.agentMsgFormat.from.name=d&&d.displayName?d.displayName:""))}if(e.role&&"AGENT"===e.role&&n.agentMsgFormat.avatar&&(c.avatar=n.agentMsgFormat.avatar),d.state&&e.role&&(a||i)){var g=d.role;l.checkEventChanged(d.id,e.state)&&("AGENT"==g&&(c.from={type:"Agent",name:d.displayName},n.oAgents[d.id]={name:d.displayName}),"CUSTOMER"==g&&(c.from={type:"Client",name:d.displayName},n.oClients[d.id]={name:d.displayName}),"WORKFLOW"===g&&(n.botEventsEnabled&&"DISCONNECTED"===e.state&&(c.from={type:"Bot"}),"standard"===e.bodyType||n.botEventsEnabled&&"member-join"===e.bodyType?(c.from={type:"Bot"},n.oWorkFlows[d.id]={type:"Bot"}):"notice"===e.bodyType&&(c.from={type:"External"},n.oWorkFlows[d.id]={type:"External"})))}if("Message"===c.type){var u=l.getSenderById(e);u&&(a||i||(c.from=u.from||{}),u.avatar&&(c.avatar=u.avatar))}return l.parseMessageForEvents(e,t),c},getSenderById:function(e){var t=l.transport,n=e.sender.id,o={},s="",r={id:n},a=[];return t.oPresences&&Object.keys(t.oPresences).length&&(a=t.oPresences.filter(function(e){return e.id==n}),a=a[0]),o=t.oMembers[n]||t.oWorkFlows[n]||a,o&&("WORKFLOW"===o.role?"standard"===e.bodyType?r.type="Bot":"notice"===e.bodyType&&(r.type="External"):"AGENT"===o.role?(r.name=t.oAgents[n]&&t.oAgents[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Agent",r.type="Agent",s=t.oMembers[n]&&t.oMembers[n].avatarImageUrl||a&&a.avatarImageUrl):"CUSTOMER"===o.role&&(r.name=t.oClients[n]&&t.oClients[n].name||t.oMembers[n]&&t.oMembers[n].displayName||"Client",r.type="Client")),{from:r,avatar:s}},checkEventChanged:function(e,t){var n=l.transport,o=n.oMembers;if(Object.keys(o).length&&o[e]){var s=o[e];return!s.lastEvent||s.lastEvent!==t}return!0},processSocketFrame:function(e){var t=l.transport,n=t.oSessionData,o=e&&e.eventBody,s=e&&e.metadata;if(o&&("WebSocket Heartbeat"==o.message||s)&&(clearTimeout(t.WebSocketTimeout),t.WebSocketTimeout=setTimeout(function(){t.mySocket&&t.mySocket.readyState===WebSocket.OPEN&&(t.bSocketConnectionLost=!0,t.onDisconnected(),t.mySocket.close())},t.socketHeartbeatTrackerInterval)),s&&o){var r=s.type,a="";switch(r){case"typing-indicator":var i=o.sender.id,c=t.oAgents,d={},m=[],g="";if(t.oPresences&&Object.keys(t.oPresences).length){m=t.oPresences.filter(function(e){return e.id==i});for(var u=0;u<m.length;u++)(m=m[u])&&"AGENT"==m.role&&(t.agentMsgFormat.avatar=m.avatarImageUrl||"")}g=t.agentMsgFormat.avatar,c[i]&&(d.from={name:c[i].name,id:i,avatar:g},t.iAgentTypingTimeout&&(clearTimeout(t.iAgentTypingTimeout),t.iAgentTypingTimeout=!1),t.onAgentTypingStarted(d),t.iAgentTypingTimeout=setTimeout(function(){clearTimeout(t.iAgentTypingTimeout),t.iAgentTypingTimeout=!1,t.onAgentTypingTimeout()},t.iAgentTypingTimer));break;case"member-change":var p=o.member;a=p.id,!t.bSessionActive&&p&&"DISCONNECTED"==p.state&&t.customerId&&a!==t.customerId&&t.oCacheAgents[a]&&t.oCacheAgents[a].connected&&(t.agentMsgFormat.type="ParticipantLeft",l.postMessageWithTimestamp(t.agentMsgFormat),t.oCacheAgents[a].connected=!1,t.oCacheAgents[a].disconnectedTime=Date.now(),t.onAgentDisconnected({message:o,agents:t.oCacheAgents}));break;case"message":var f=o.bodyType;a=o.sender.id,"standard"!=f&&"notice"!=f&&l.checkMemberEvents(f,n,a),n.lastMessageId=o.id,l.updateSessionCookies(),t.aMsgsBuffer.push(o),t.fWatchMembers||(t.fWatchMembers=setInterval(function(){var e=[],n=t.aMsgsBuffer.filter(function(n){if(!n.sender.id)return n;if(t.oPresences&&Object.keys(t.oPresences).length&&(e=t.oPresences.filter(function(e){return e.id==n.sender.id}),e=e[0]),t.oMembers[n.sender.id]||e){var o=t.oMembers[n.sender.id]||e,s=o.role;if(s&&"AGENT"===s&&t.iAgentTypingTimeout)var r=setTimeout(function(){clearTimeout(r),t.onAgentTypingStopped(),clearTimeout(t.iAgentTypingTimeout),t.iAgentTypingTimeout=!1},0);return n}});t.bFetchingMembers||n.length!=t.aMsgsBuffer.length||(clearInterval(t.fWatchMembers),t.fWatchMembers=!1,l.parseTranscript(t.aMsgsBuffer),t.aMsgsBuffer=[])},t.iWatchMembers))}}},postMessageWithTimestamp:function(e){var t=l.transport;e.timestamp=Date.now(),e.index=e.timestamp,t.onMessageReceived({data:{originalMessages:[e],messages:[e],restoring:t.bRestoring}})},getNickname:function(e){return e.nickname?e.nickname:e.firstName&&e.lastName&&"string"==typeof e.firstName&&"string"==typeof e.lastName?e.firstName+" "+e.lastName:e.firstName&&"string"==typeof e.firstName?e.firstName:e.lastName&&"string"==typeof e.lastName?e.lastName:"Customer"},getPresences:function(){var e=m.default.Deferred(),t=l.transport,n=t.oSessionData,o=l.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/members");return u.default.request(c({},t.oCommonRequestOption,{headers:{Authorization:"Bearer "+t.oSessionData.jwt},type:"GET",url:o,success:function(t){t&&e.resolve(t)},error:function(t){return e.reject(t)}})),e.promise()},requestMessages:function(e,t,n){var o=l.transport;u.default.request(c({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"GET",url:e,success:function(s){s?(s.entities&&(t=t.concat(s.entities)),s.next?(e=o.dataURL+s.next,l.requestMessages(e,t,n)):n.resolve(t)):n.reject(s)},error:function(e){return n.reject(e)}}))},getAllMessages:function(){var e=m.default.Deferred(),t=l.transport,n=t.oSessionData,o=[],s=l.CreateUrl("/api/v2/webchat/guest/conversations/"+n.conversationId+"/messages");return l.requestMessages(s,o,e),e.promise()},getOfflineMessages:function(){var e=m.default.Deferred(),t=m.default.Deferred(),n=l.transport,o=n.oSessionData,s="",r=[];if(o.conversationId&&o.lastMessageId)return s=l.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",{after:o.lastMessageId}),l.requestMessages(s,r,e),e.promise().done(function(e){l.getPresences().done(function(o){n.bFetchingMembers=!1,n.oPresences=o.entities,l.parseTranscript(e,{type:"offlineMessages"}),t.resolve()}).fail(function(){t.resolve()})}),t.promise()},getNextHundredMessages:function(e){var t=m.default.Deferred(),n=l.transport,o=n.oSessionData,s=[],r="",a={sortOrder:"descending",maxResults:n.maxMessagePageSize};return""!==o.nextMsgURL&&o.previousLastMsgId&&(a.before=o.previousLastMsgId),!n.bAllMessagesReceived&&o.conversationId?(r=l.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/messages",a),u.default.request(c({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:r,success:function(r){r?(r.entities&&(s=r.entities),r.next?(o.previousLastMsgId=s[s.length-1].id,o.nextMsgURL=r.next,n.bAllMessagesReceived=!1):(n.bAllMessagesReceived=!0,o.nextMsgURL=""),l.getPresences().done(function(o){n.oPresences=o.entities,s.length&&s.length<r.pageSize&&!r.next&&(n.bAllMessagesReceived=!0),l.parseTranscript(s,e),t.resolve()}).fail(function(e){t.reject(e)})):(l.handleError(r),t.reject("200 but no response from server"))},error:function(e){n.onError(e),t.reject()}}))):t.reject("No more messages to fetch"),t.promise()},sendRequest:function(e,t){var n=m.default.Deferred(),o=l.transport,s=e?{data:JSON.stringify(e)}:{};return u.default.request(c({},o.oCommonRequestOption,{headers:{Authorization:"Bearer "+o.oSessionData.jwt},type:"POST",url:t},s,{success:function(e){return n.resolve(e)},error:function(e){return n.reject(e)}})),n.promise()},getMemberById:function(e){var t=m.default.Deferred(),n=l.transport,o=n.oSessionData;return o.conversationId&&e?(n.bFetchingMembers=!0,u.default.request(c({},n.oCommonRequestOption,{headers:{Authorization:"Bearer "+n.oSessionData.jwt},type:"GET",url:l.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+e),success:function(e){e?t.resolve({id:e.id,displayName:e.displayName,role:e.role,customFields:e.customFields,state:e.state,avatarImageUrl:e.avatarImageUrl||""}):(t.reject(e),n.onError(e))},error:function(e){n.bFetchingMembers=!1,l.handleError(e),t.reject(e||{})}}))):t.reject("No session data available"),t.promise()},getMe:function(){var e=m.default.Deferred(),t=l.transport,n=t.oSessionData;return l.getMemberById(n.memberId).done(function(o){t.bFetchingMembers=!1,t.oClients[n.memberId]={name:o.displayName},t.oMembers[n.memberId]=o,e.resolve(o)}).fail(function(t){e.reject(t)}),e.promise()},getConversationState:function(){var e=m.default.Deferred();return l.getMe().done(function(t){e.resolve(t)}).fail(function(t){e.reject("failed to get the conversation state")}),e.promise()},handleError:function(e){var t=l.transport,n=e&&(e.responseJSON||e.responseText&&JSON.parse(e.responseText)||{});if(n)var o=n.status;t.onError({code:e.errorReason||o&&t.errorPrefix+o||"",response:e})},CreateUrl:function(e,t){var n="",o=l.transport;if(t){n="?";var s=[];for(var r in t){var a=t[r];"string"!=typeof a&&"number"!=typeof a||s.push(r+"="+t[r])}n+=s.join("&")}return""+o.dataURL+e+n},afterConnectionRestore:function(){var e=l.transport;e.bOpeningSocket=!1,l.getOfflineMessages().done(function(){l.getConversationState().done(function(t){e.bSessionActive&&t&&"DISCONNECTED"===t.state&&(e.onChatEnded(),l.terminateChatSession())})})},subscribeSocketEvents:function(e){var t=l.transport;t.mySocket.onmessage=function(e){var t=JSON.parse(e.data);l.processSocketFrame(t)},t.mySocket.addEventListener("close",function(e){clearTimeout(t.WebSocketTimeout),t.bSocketConnectionLost=!0,t.mySocket=null,t.bSessionActive&&(t.bOpeningSocket=!0,l.startWebSocketConnection().done(function(){l.afterConnectionRestore()}))}),t.mySocket.addEventListener("error",function(n){t.bSocketConnectionLost||l.handleError(n),t.bSessionActive||(e.reject("websocket failed to open"),t.bRestoring&&t.onRestoreFailed()),t.bOpeningSocket=!1})},startWebSocketConnection:function(e){var t=l.transport,n=m.default.Deferred();return e&&(t.oSessionData={jwt:e.jwt,conversationId:e.id,memberId:e.member.id,WebSocketUrl:e.eventStreamUri},t.customerId=e.member.id),t.mySocket=new WebSocket(t.oSessionData.WebSocketUrl),t.mySocket.addEventListener("open",function(e){t.bSessionActive=!0,t.bSocketConnectionLost&&(t.bSocketConnectionLost=!1,t.onReconnected()),n.resolve()}),l.subscribeSocketEvents(n),n.promise()},checkMemberEvents:function(e,t,n){var o=l.transport,s="",r=[];s=o.oMembers[n]&&o.oMembers[n].lastEvent?o.oMembers[n].lastEvent:"",t.memberId&&o.bSessionActive&&l.getMemberById(n).done(function(a){"member-join"==e&&(n!=t.memberId?(o.oMembers[n]=a,s&&(o.oMembers[n].lastEvent=s),a&&l.checkEventChanged(n,"CONNECTED")&&("AGENT"==a.role?(o.agentMsgFormat.avatar=a.avatarImageUrl,"CONNECTED"==a.state&&(o.agentMsgFormat.type="ParticipantJoined",o.agentMsgFormat.from.name=a.displayName||"",void 0==o.oAgents[n]&&(o.oAgents[n]={name:a.displayName||"",connected:!0,supervisor:!1,connectedTime:Date.now(),disconnectedTime:!1}),o.oCacheAgents[n]=JSON.parse(JSON.stringify(o.oAgents[n])),o.oCacheAgents[n].connected=!0,l.postMessageWithTimestamp(o.agentMsgFormat),o.onAgentConnected({message:a,agents:o.oAgents}))):"WORKFLOW"===a.role&&"CONNECTED"==a.state&&(void 0==o.oWorkFlows[n]&&(o.oWorkFlows[n]={name:a.displayName||"",role:"WORKFLOW",connected:!0,connectedTime:Date.now(),disconnectedTime:!1}),o.botEventsEnabled&&l.sendBotConnected(a)),o.oMembers[n]=a,o.oMembers[n].lastEvent=a.state),o.bFetchingMembers=!1):n==t.memberId&&(o.oMembers[n]=a,a&&"CUSTOMER"==a.role&&l.checkEventChanged(n,"CONNECTED")&&(o.oMembers[n].lastEvent=a.state))),"member-leave"==e&&(n!=t.memberId?(o.oMembers[n]=a,s&&(o.oMembers[n].lastEvent=s),o.oPresences&&Object.keys(o.oPresences).length&&(r=o.oPresences.filter(function(e){return e.id==n}),r=r[0]),a&&l.checkEventChanged(n,"DISCONNECTED")&&("AGENT"==a.role?(o.agentMsgFormat.avatar=a.avatarImageUrl,"DISCONNECTED"==a.state&&(o.agentMsgFormat.type="ParticipantLeft",o.agentMsgFormat.from.name=a.displayName||"",void 0!==o.oAgents[n]&&(o.oAgents[n].name=a.displayName,o.oAgents[n].connected=!1,o.oAgents[n].disconnectedTime=Date.now()),(o.oCacheAgents[n]&&o.oCacheAgents[n].connected||r&&"AGENT"==r.role&&"CONNECTED"==r.state)&&(void 0!==o.oCacheAgents[n]&&(o.oCacheAgents[n].connected=!1,o.oCacheAgents[n].disconnectedTime=Date.now(),o.oCacheAgents[n].name=a.displayName),l.postMessageWithTimestamp(o.agentMsgFormat),o.onAgentDisconnected({message:a,agents:o.oCacheAgents})))):"WORKFLOW"===a.role&&"DISCONNECTED"==a.state&&(void 0!==o.oWorkFlows[n]&&(o.oWorkFlows[n].name=a.displayName||"",o.oWorkFlows[n].connected=!1,o.oWorkFlows[n].disconnectedTime=Date.now()),o.botEventsEnabled&&l.sendBotDisconnected(a)),o.oMembers[n]=a,o.oMembers[n].lastEvent=a.state),o.bFetchingMembers=!1):n==t.memberId&&(o.oMembers[n]=a,a&&l.checkEventChanged(n,"DISCONNECTED")&&(o.bSessionActive&&"CUSTOMER"==a.role&&"DISCONNECTED"==a.state&&setTimeout(function(){o.onChatEnded(),l.terminateChatSession()},600),o.oMembers[n].lastEvent=a.state)))}).fail(function(e){l.handleError(e)})}},p=function(){function e(t){if(s(this,e),this.transportType="",this.dataURL="",this.mySocket={},this.oUserData=t.oUserData,this.errorPrefix=t.transport.type+"-",this.oChatIndexHash={},this.oPresences={},this.oMembers={},this.oAgents={},this.oClients={},this.oCacheAgents={},this.oWorkFlows={},this.aMsgsBuffer=[],this.maxMessagePageSize=100,this.botEventsEnabled=!1,this.oInteractionData=t.oInteractionData,this.bOpeningSocket=!1,this.bSessionActive=!1,this.bRestoring=!1,this.bAllMessagesReceived=!1,this.bFetchingMembers=!1,this.ajaxTimeout=t.iAjaxTimeout&&t.iAjaxTimeout>=12e3?t.iAjaxTimeout:12e3,this.oCommonRequestOption={timeout:this.ajaxTimeout,crossDomain:!0,dataType:"json",contentType:"application/json"},this.conversationOptions={deploymentId:"",organizationId:"",routingTarget:{targetAddress:""},memberInfo:{displayName:"Customer",role:"CUSTOMER",customFields:{}}},this.oMapping={"form.firstname":{target:"memberInfo.customFields.firstName",type:"string"},"form.lastname":{target:"memberInfo.customFields.lastName",type:"string"},"form.email":{target:"memberInfo.customFields.email",type:"string"},"form.subject":{target:"memberInfo.customFields.subject",type:"string"},"userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.userData.phone":{target:"memberInfo.customFields.phoneNumber",type:"string"},"interactionData.routing.targetType":{target:"routingTarget.targetType",type:"string",default:"QUEUE"},"interactionData.routing.targetAddress":{target:"routingTarget.targetAddress",type:"string"},"interactionData.routing.skills":{target:"routingTarget.skills"},"interactionData.routing.priority":{target:"routingTarget.priority",type:"number"},"interactionData.routing.language":{target:"routingTarget.language",type:"string"},"interactionData.journey.customerId":{target:"journeyContext.customer.id",type:"string"},"interactionData.journey.customerIdType":{target:"journeyContext.customer.idType",type:"string"},"interactionData.journey.sessionId":{target:"journeyContext.customerSession.id",type:"string"},"interactionData.journey.sessionType":{target:"journeyContext.customerSession.type",type:"string"},"interactionData.journey.actionId":{target:"journeyContext.triggeringAction.id",type:"string"},"interactionData.journey.actionMapId":{target:"journeyContext.triggeringAction.actionMap.id",type:"string"},"interactionData.journey.actionMapVersion":{target:"journeyContext.triggeringAction.actionMap.version",type:"number"}},this.webSocketStateMapping={"member-join":"ParticipantJoined","member-leave":"ParticipantLeft",standard:"Message",notice:"Message"},this.stateMapping={ParticipantJoined:"CONNECTED",ParticipantLeft:"DISCONNECTED"},this.oSessionData={jwt:"",conversationId:"",memberId:"",displayName:"",WebSocketUrl:"",nextMsgURL:"",lastMessageId:""},this.customerId="",this.bSocketConnectionLost=!1,this.socketReconnectInterval=2e3,this.socketHeartbeatTrackerInterval=14e3,this.socketConnectionCloseTime=2,this.capabilities={pagination:!0,fileUpload:!1},"object"==i(t.transport)){var n=t.transport;"string"==typeof n.type&&(this.transportType=n.type),"string"==typeof n.dataURL&&(this.dataURL=n.dataURL),"string"==typeof n.deploymentKey&&(this.conversationOptions.deploymentId=n.deploymentKey),"string"!=typeof n.organizationId&&"string"!=typeof n.orgGuid||(this.conversationOptions.organizationId=n.organizationId||n.orgGuid),"number"==typeof n.socketReconnectInterval&&(this.socketReconnectInterval=n.socketReconnectInterval),"number"==typeof n.socketHeartbeatTrackerInterval&&(this.socketHeartbeatTrackerInterval=n.socketHeartbeatTrackerInterval),"boolean"==typeof n.pagination&&(this.capabilities.pagination=n.pagination),"number"==typeof n.maxMessagePageSize&&(this.maxMessagePageSize=n.maxMessagePageSize),"boolean"==typeof n.botEventsEnabled&&(this.botEventsEnabled=n.botEventsEnabled),"number"==typeof n.socketConnectionCloseTime&&(this.socketConnectionCloseTime=n.socketConnectionCloseTime),this.conversationOptions=u.default.mapProperties(this.oMapping,n,this.conversationOptions)}this.sCookie_Keys=t.sCookie_Prefix+"."+this.transportType+".JWtoken",this.sCookie_ConversationID=t.sCookie_Prefix+"."+this.transportType+".ConversationID",this.sCookie_MemberID=t.sCookie_Prefix+"."+this.transportType+".MemberID",this.sCookie_WS_URL=t.sCookie_Prefix+"."+this.transportType+".WS_URL",this.sLastMessageId=t.sCookie_Prefix+"."+this.transportType+".LastMsgId",this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onRestore=this.onRestore.bind(this),this.onError=this.onError.bind(this),this.agentMsgFormat={type:"",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Agent"}},this.conversationStarted={type:"ParticipantJoined",text:"",restoring:!1,index:0,timestamp:0,from:{type:"Client"}},this.iAgentTypingTimer=3e3,this.iAgentTypingTimeout=!1,this.fWatchMembers=!1,this.iWatchMembers=700,l.init(this)}return a(e,[{key:"onChatStarted",value:function(e,t){}},{key:"onTypingStarted",value:function(e){}},{key:"onCapabilitiesChanged",value:function(e){}},{key:"onAgentTypingStarted",value:function(e){}},{key:"onAgentTypingTimeout",value:function(e){}},{key:"onMessageReceived",value:function(e){}},{key:"onChatEnded",value:function(e){}},{key:"onError",value:function(e){}},{key:"onRestore",value:function(e){}},{key:"onRestoreFailed",value:function(e){}},{key:"startChat",value:function(e){var t=m.default.Deferred(),n=this,o="",s=JSON.parse(JSON.stringify(n.conversationOptions)),r=l.getFormData(e.form);return s.memberInfo.customFields=m.default.extend(s.memberInfo.customFields,r,e.userData||{},!0),s.memberInfo.displayName=l.getNickname(r),"string"==typeof e.deploymentKey&&(s.deploymentId=e.deploymentKey),"string"!=typeof e.organizationId&&"string"!=typeof e.orgGuid||(s.organizationId=e.organizationId||e.orgGuid),n.oInteractionData&&Object.keys(n.oInteractionData).length>0&&(o=n.oInteractionData),e&&e.interactionData&&Object.keys(e.interactionData).length>0&&(o=e.interactionData),o&&(s.memberInfo.customFields=m.default.extend(s.memberInfo.customFields,o.userData||{},!0),s=u.default.mapProperties(n.oMapping,{interactionData:o,userData:s.memberInfo.customFields},s)),n.bSessionActive||n.bOpeningSocket||(n.bOpeningSocket=!0,u.default.request(c({},n.oCommonRequestOption,{type:"POST",url:l.CreateUrl("/api/v2/webchat/guest/conversations"),data:JSON.stringify(s),success:function(e){e?l.startWebSocketConnection(e).done(function(){l.updateSessionCookies(),n.onChatStarted({data:n.oSessionData},e),l.getMe(),t.resolve(),l.postMessageWithTimestamp(n.conversationStarted),n.onClientConnected({message:n.conversationStarted,agents:n.oAgents}),n.bOpeningSocket=!1}):(t.reject("no response data in the api post request"),n.onError(e))},error:function(e){e.errorReason="StartFailed",n.bOpeningSocket=!1,t.reject(e||{}),l.handleError(e)}}))),t.promise()}},{key:"sendMessage",value:function(e){var t=m.default.Deferred(),n=this,o=n.oSessionData;if(n.bSessionActive){"text"==e.type&&(e.type="Text");var s=l.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+o.memberId+"/messages");l.sendRequest({body:e.message},s).done(function(e){o.lastMessageId=e.id,l.updateSessionCookies(),t.resolve()}).fail(function(e){e.errorReason="MessageFailed",l.handleError(e),t.reject()})}else t.reject("There is no active chat session.");return t.promise()}},{key:"sendFile",value:function(){return m.default.Deferred().reject("This transport doesn't support file uploads.").promise()}},{key:"sendTyping",value:function(e){var t=m.default.Deferred(),n=this,o=n.oSessionData;if(n.bSessionActive)if(e&&"TypingStopped"!==e.type){var s=l.CreateUrl("/api/v2/webchat/guest/conversations/"+o.conversationId+"/members/"+o.memberId+"/typing");l.sendRequest("",s).done(function(e){e?t.resolve():t.reject("send typing indicator request returned no data")}).fail(function(e){t.reject(e||{})})}else t.resolve();else t.reject("trying to send typing indicator when session is not active");return t.promise()}},{key:"fetchHistory",value:function(){var e=m.default.Deferred();return this.capabilities.pagination?l.getNextHundredMessages({type:"fetchHistory"}).done(function(){e.resolve()}).fail(function(t){e.reject(t)}):e.reject("Fetching chat history on scroll is not enabled."),e.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"restore",value:function(){var e=this,t=e.oSessionData,n=m.default.Deferred();return e.onCapabilitiesChanged(this.capabilities),e.bRestoring?n.reject("Already restoring. Ignoring request."):e.bSessionActive?n.reject("Chat session is already active, ignoring restore command."):(l.getSessionFromCookie(),t.conversationId?(e.bRestoring=!0,l.getConversationState().done(function(o){e.bFetchingMembers=!1,"CONNECTED"==o.state?(e.mySocket=new WebSocket(t.WebSocketUrl),l.subscribeSocketEvents(n),e.mySocket.addEventListener("open",function(t){e.bSessionActive=!0,e.bSocketConnectionLost=!1,e.mySocket.onmessage=function(e){var t=JSON.parse(e.data);l.processSocketFrame(t)},e.onRestore(),e.capabilities.pagination?l.getNextHundredMessages({type:"restore"}).done(function(){e.bRestoring=!1,n.resolve()}):l.getAllMessages().done(function(t){l.getPresences().done(function(n){e.oPresences=n.entities,l.parseTranscript(t,{type:"restore"})}),e.bRestoring=!1,n.resolve()}).fail(function(t){e.onRestoreFailed(t)})})):(e.onRestoreFailed(o),n.reject("customer disconnected, conversation ended"))}).fail(function(t){e.onRestoreFailed(t),n.reject("failed to retrieve conversation state")})):n.reject("No chat session found to restore.")),n.promise()}},{key:"fetchSessionAndRestoringInfo",value:function(){var e=!1;return l.getSessionFromCookie(),this.oSessionData&&this.oSessionData.conversationId&&(e=!0),{bRestoring:this.bRestoring,bSessionValid:e}}},{key:"asyncRestore",value:function(){return this.restore()}},{key:"endChat",value:function(){var e=m.default.Deferred(),t=this.oSessionData,n=t.conversationId,o=t.memberId,s=this;return this.bSessionActive?(u.default.request({timeout:12e3,crossDomain:!0,contentType:"application/json; charset=utf-8",cache:!1,headers:{Authorization:"Bearer "+s.oSessionData.jwt},type:"DELETE",url:l.CreateUrl("/api/v2/webchat/guest/conversations/"+n+"/members/"+o),success:function(e){setTimeout(function(){s.bSessionActive||l.terminateChatSession()},500)}}).always(function(t,n,o){var r=o||t;if(r){var a=r.status,i=r.responseText;!a||204!=a&&200!=a?(s.onError({code:a||"",message:i&&i.message?i.message:""}),e.reject(r)):(s.bSessionActive&&s.onChatEnded(r),e.resolve(r))}else s.onError(),e.reject(r);l.terminateChatSession()}),e.promise()):(e.reject("There is no active chat session"),s.onChatEnded(),l.terminateChatSession(),e.promise())}},{key:"updateUserData",value:function(){return m.default.Deferred().reject("This transport doesn't support updating userData during an active chat session.").promise()}},{key:"updateInteractionData",value:function(){return m.default.Deferred().reject("This transport doesn't support updating interactionData during an active chat session.").promise()}}]),e}();CXBus.registerModule("pure-cloud-v2-sockets-transport",p)}},["./webapp/plugins/cx-webchat-service/transports/pure-cloud-v2-sockets-transport.js"]);